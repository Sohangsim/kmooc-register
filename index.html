<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ëŒ€êµ¬ëŒ€ KMOOC ì†Œí–‰ì‹¬</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-size: 1.1rem;
    }
    .container {
      background-color: white;
      padding: 2.5rem;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      max-width: 520px;
      width: 100%;
    }
    h2 {
      font-size: 1.6rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .subtext {
      font-size: 1rem;
      color: #555;
      text-align: center;
      margin-bottom: 2rem;
    }
    label {
      display: block;
      margin-top: 1.2rem;
      font-weight: 600;
      font-size: 1.1rem;
    }
    input {
      width: 100%;
      padding: 0.8rem;
      font-size: 1.1rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      width: 100%;
      padding: 0.8rem;
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #result {
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: #eef4ff;
      border-left: 6px solid #0078d4;
      border-radius: 10px;
      font-size: 1.1rem;
      color: #003366;
      line-height: 1.6;
      white-space: pre-line;
    }
    .hidden {
      display: none;
    }
    .loader {
      font-size: 0.95rem;
      color: #888;
      margin-top: 0.5rem;
      text-align: center;
    }
    .contact {
      margin-top: 2.5rem;
      text-align: center;
      font-size: 0.95rem;
      color: #555;
    }
    .contact span {
      font-weight: bold;
      cursor: pointer;
      user-select: all;
    }
    #contactLoader {
      font-size: 0.85rem;
      color: #888;
      margin-left: 0.5rem;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ë³¸ì¸ í•™ë²ˆìœ¼ë¡œ KMOOC ì´ë©”ì¼ ì¡°íšŒ ë° ë“±ë¡</h2>
    <p class="subtext">ë“±ë¡ëœ ì´ë©”ì¼ì€ KMOOC ì„±ì ë¶€ í™•ì¸ ë° ì¤‘ê°„ê³ ì‚¬ ì±„ì ì— í™œìš©ë©ë‹ˆë‹¤.</p>

    <!-- ğŸ”½ ì´ë¯¸ì§€ ì•ˆë‚´ ì„¹ì…˜ ì‹œì‘ -->
    <div id="imageGuideSection" style="text-align: center;">
      <p id="guideText" style="margin-bottom: 1rem; color: #333;">
        ë³¸ì¸ KMOOC ì´ë©”ì¼ì€ ë‹¤ìŒê³¼ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
      <img
        id="guideImage"
        src="./im1.png"
        alt="ì´ë©”ì¼ í™•ì¸ ì˜ˆì‹œ"
        style="max-width: 100%; border-radius: 10px; border: 1px solid #ccc;"
      />
      <button
        id="toggleBtn"
        style="margin-top: 1.5rem; background-color: #28a745; color: white; padding: 0.8rem; width: 100%; border: none; border-radius: 6px; font-weight: bold; font-size: 1.1rem; cursor: pointer;">
        ì„±ì ë¶€ í™•ì¸ ë°©ë²•
      </button>
    </div>
    <!-- ğŸ”¼ ì´ë¯¸ì§€ ì•ˆë‚´ ì„¹ì…˜ ë -->

    <label for="studentId">í•™ë²ˆ</label>
    <input type="text" id="studentId" placeholder="8ìë¦¬ ìˆ«ì ì…ë ¥ (ì˜ˆ: 12345678)" maxlength="8" />
    <button id="checkBtn">ì¡°íšŒ</button>

    <div id="loader" class="loader hidden">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
    <div id="result" class="hidden"></div>

    <div id="emailSection" class="hidden">
      <label for="newEmail">ì´ë©”ì¼</label>
      <input type="email" id="newEmail" placeholder="ì´ë©”ì¼ ë“±ë¡ ë˜ëŠ” ìˆ˜ì •" />
      <button id="saveBtn">ì €ì¥</button>
    </div>

    <hr style="margin:2.5rem 0 1rem" />
    <p class="contact">
      ë¬¸ì˜ì‚¬í•­: <span id="contactEmail"></span><span id="contactLoader">(ë¡œë”© ì¤‘...)</span><br />
      <small>í´ë¦­ ë˜ëŠ” ë³µì‚¬í•˜ì„¸ìš”</small>
    </p>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzpgOknURiuHpduRzHPYux087y7p7xI1sR4OAzEsSLOyE00E8P-sxpEV4f9cExwCv2W/exec";
    const idRegex = /^\d{8}$/;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    const studentId = document.getElementById("studentId");
    const newEmail = document.getElementById("newEmail");
    const checkBtn = document.getElementById("checkBtn");
    const saveBtn = document.getElementById("saveBtn");
    const loader = document.getElementById("loader");
    const result = document.getElementById("result");
    const emailSection = document.getElementById("emailSection");
    const contactEmail = document.getElementById("contactEmail");
    const contactLoader = document.getElementById("contactLoader");

    function toggleLoader(show) {
      loader.classList.toggle("hidden", !show);
      checkBtn.disabled = saveBtn.disabled = show;
    }

    function displayMessage(msg, isError = false) {
      result.textContent = msg;
      result.style.color = isError ? "#b30000" : "#003366";
      result.classList.remove("hidden");
    }

    function loadAdminEmail() {
      contactEmail.textContent = 'ì ì‹œ í›„ ì´ë©”ì¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤';
      contactLoader.style.display = 'inline';
      fetch(`${scriptURL}?mode=adminEmail`)
        .then(res => res.json())
        .then(data => {
          contactEmail.textContent = data.adminEmail || 'ê´€ë¦¬ì ì´ë©”ì¼ ì—†ìŒ';
        })
        .catch(() => {
          contactEmail.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
        })
        .finally(() => {
          contactLoader.style.display = 'none';
        });
    }

    checkBtn.addEventListener("click", () => {
      const id = studentId.value.trim();
      if (!idRegex.test(id)) return alert("í•™ë²ˆì€ 8ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");

      result.classList.add("hidden");
      emailSection.classList.add("hidden");
      toggleLoader(true);

      fetch(`${scriptURL}?id=${encodeURIComponent(id)}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            displayMessage(`âŒ ${data.error}`, true);
            return;
          }
          if (!data.email) {
            displayMessage("ë“±ë¡ëœ ì´ë©”ì¼ì´ ì—†ìŠµë‹ˆë‹¤. KMOOC ì´ë©”ì¼ì„ ë“±ë¡í•´ì£¼ì„¸ìš”");
          } else {
            let raw = data.time.replace('T',' ').split('.')[0];
            const formatted = raw.slice(0,16);
            displayMessage(`ë“±ë¡ëœ ì´ë©”ì¼: ${data.email}\nìµœê·¼ ë“±ë¡/ìˆ˜ì •: ${formatted}`);
          }
          emailSection.classList.remove("hidden");
          newEmail.focus();
        })
        .catch(() => displayMessage("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true))
        .finally(() => toggleLoader(false));
    });

    saveBtn.addEventListener("click", () => {
      const id = studentId.value.trim();
      const email = newEmail.value.trim();
      if (!idRegex.test(id) || !email) return alert("í•™ë²ˆê³¼ ì´ë©”ì¼ì„ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      if (!emailRegex.test(email)) return alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      displayMessage("â³ ì„œë²„ì— ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...");
      toggleLoader(true);

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({ id, email })
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) displayMessage(`âŒ ${data.error}`, true);
          else if (data.status === 'updated') displayMessage("âœ… ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
          else if (data.status === 'appended') displayMessage("âœ… ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
          emailSection.classList.add("hidden");
          newEmail.value = '';
        })
        .catch(() => displayMessage("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true))
        .finally(() => toggleLoader(false));
    });

    contactEmail.addEventListener("click", () => {
      navigator.clipboard.writeText(contactEmail.textContent)
        .then(() => alert("ì´ë©”ì¼ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."))
        .catch(() => alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    });

    // ì´ë¯¸ì§€ í† ê¸€ ê¸°ëŠ¥
    const guideImage = document.getElementById("guideImage");
    const guideText = document.getElementById("guideText");
    const toggleBtn = document.getElementById("toggleBtn");
    let showingEmailGuide = true;

    toggleBtn.addEventListener("click", () => {
      if (showingEmailGuide) {
        guideImage.src = "./image2.png";
        guideText.textContent = "ë³¸ì¸ì˜ KMOOC ì„±ì ë¶€ëŠ” ë‹¤ìŒê³¼ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        toggleBtn.textContent = "KMOOC ì´ë©”ì¼ í™•ì¸ ë°©ë²•";
      } else {
        guideImage.src = "./im1.png";
        guideText.textContent = "ë³¸ì¸ KMOOC ì´ë©”ì¼ì€ ë‹¤ìŒê³¼ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        toggleBtn.textContent = "ì„±ì ë¶€ í™•ì¸ ë°©ë²•";
      }
      showingEmailGuide = !showingEmailGuide;
    });

    window.addEventListener('DOMContentLoaded', loadAdminEmail);
  </script>
</body>
</html>
