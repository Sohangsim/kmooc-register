<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>대구대 KMOOC 소행심</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-size: 1.1rem;
    }
    .container {
      background-color: white;
      padding: 2.5rem;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      max-width: 520px;
      width: 100%;
    }
    h2 {
      font-size: 1.6rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .subtext {
      font-size: 1rem;
      color: #555;
      text-align: center;
      margin-bottom: 2rem;
    }
    label {
      display: block;
      margin-top: 1.2rem;
      font-weight: 600;
      font-size: 1.1rem;
    }
    input {
      width: 100%;
      padding: 0.8rem;
      font-size: 1.1rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      width: 100%;
      padding: 0.8rem;
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #result {
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: #eef4ff;
      border-left: 6px solid #0078d4;
      border-radius: 10px;
      font-size: 1.1rem;
      color: #003366;
      line-height: 1.6;
      white-space: pre-line;
    }
    .hidden {
      display: none;
    }
    .loader {
      font-size: 0.95rem;
      color: #888;
      margin-top: 0.5rem;
      text-align: center;
    }
    .contact {
      margin-top: 2.5rem;
      text-align: center;
      font-size: 0.95rem;
      color: #555;
    }
    .contact span {
      font-weight: bold;
      cursor: pointer;
      user-select: all;
    }
    #contactLoader {
      font-size: 0.85rem;
      color: #888;
      margin-left: 0.5rem;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>본인 학번으로 KMOOC 이메일 조회 및 등록</h2>
    <p class="subtext">등록된 이메일은 KMOOC 성적부 확인 및 중간고사 채점에 활용됩니다.</p>

    <label for="studentId">학번</label>
    <input type="text" id="studentId" placeholder="8자리 숫자 입력 (예: 12345678)" maxlength="8" />
    <button id="checkBtn">조회</button>

    <div id="loader" class="loader hidden">잠시만 기다려주세요...</div>
    <div id="result" class="hidden"></div>

    <div id="emailSection" class="hidden">
      <label for="newEmail">이메일</label>
      <input type="email" id="newEmail" placeholder="이메일 등록 또는 수정" />
      <button id="saveBtn">저장</button>
    </div>

    <hr style="margin:2.5rem 0 1rem" />
    <p class="contact">
      문의사항: <span id="contactEmail"></span><span id="contactLoader">(로딩 중...)</span><br />
      <small>클릭 또는 복사하세요</small>
    </p>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzpgOknURiuHpduRzHPYux087y7p7xI1sR4OAzEsSLOyE00E8P-sxpEV4f9cExwCv2W/exec";
    const idRegex = /^\d{8}$/;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    const studentId = document.getElementById("studentId");
    const newEmail = document.getElementById("newEmail");
    const checkBtn = document.getElementById("checkBtn");
    const saveBtn = document.getElementById("saveBtn");
    const loader = document.getElementById("loader");
    const result = document.getElementById("result");
    const emailSection = document.getElementById("emailSection");
    const contactEmail = document.getElementById("contactEmail");
    const contactLoader = document.getElementById("contactLoader");

    function toggleLoader(show) {
      loader.classList.toggle("hidden", !show);
      checkBtn.disabled = saveBtn.disabled = show;
    }

    function displayMessage(msg, isError = false) {
      result.textContent = msg;
      result.style.color = isError ? "#b30000" : "#003366";
      result.classList.remove("hidden");
    }

    // 문의 이메일 불러오기
    function loadAdminEmail() {
      contactEmail.textContent = '잠시 후 이메일이 나타납니다';
      contactLoader.style.display = 'inline';
      fetch(`${scriptURL}?mode=adminEmail`)
        .then(res => res.json())
        .then(data => {
          contactEmail.textContent = data.adminEmail || '관리자 이메일 없음';
        })
        .catch(() => {
          contactEmail.textContent = '불러오기 실패';
        })
        .finally(() => {
          contactLoader.style.display = 'none';
        });
    }

    // 학번 조회
    checkBtn.addEventListener("click", () => {
      const id = studentId.value.trim();
      if (!idRegex.test(id)) return alert("학번은 8자리 숫자여야 합니다.");

      result.classList.add("hidden");
      emailSection.classList.add("hidden");
      toggleLoader(true);

      fetch(`${scriptURL}?id=${encodeURIComponent(id)}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            displayMessage(`❌ ${data.error}`, true);
            return;
          }
          if (!data.email) {
            displayMessage("등록된 이메일이 없습니다. KMOOC 이메일을 등록해주세요");
          } else {
            let raw = data.time.replace('T',' ').split('.')[0];
            const formatted = raw.slice(0,16);
            displayMessage(`등록된 이메일: ${data.email}\n최근 등록/수정: ${formatted}`);
          }
          emailSection.classList.remove("hidden");
          newEmail.focus();
        })
        .catch(() => displayMessage("조회 중 오류가 발생했습니다.", true))
        .finally(() => toggleLoader(false));
    });

    // 이메일 저장
    saveBtn.addEventListener("click", () => {
      const id = studentId.value.trim();
      const email = newEmail.value.trim();
      if (!idRegex.test(id) || !email) return alert("학번과 이메일을 모두 올바르게 입력해주세요.");
      if (!emailRegex.test(email)) return alert("올바른 이메일 형식을 입력해주세요.");

      displayMessage("⏳ 서버에 저장 중입니다...");
      toggleLoader(true);

      fetch(scriptURL, {
        method: 'POST',
        body: new URLSearchParams({ id, email })
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) displayMessage(`❌ ${data.error}`, true);
          else if (data.status === 'updated') displayMessage("✅ 이메일이 성공적으로 수정되었습니다.");
          else if (data.status === 'appended') displayMessage("✅ 이메일이 성공적으로 등록되었습니다.");
          emailSection.classList.add("hidden");
          newEmail.value = '';
        })
        .catch(() => displayMessage("저장 중 오류가 발생했습니다.", true))
        .finally(() => toggleLoader(false));
    });

    // 이메일 클릭 시 복사
    contactEmail.addEventListener("click", () => {
      navigator.clipboard.writeText(contactEmail.textContent)
        .then(() => alert("이메일 주소가 복사되었습니다."))
        .catch(() => alert("복사에 실패했습니다."));
    });

    window.addEventListener('DOMContentLoaded', loadAdminEmail);
  </script>
</body>
</html>
